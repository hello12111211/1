name: Auto Increment Version in README

on:
  push:
    branches:
      - main

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Extract current version from README
      - name: Extract current version
        id: read_version
        run: |
          # Find the line containing the Version Badge comment
          LINE=$(grep "<!-- Version Badge -->" README.md)
          # Extract version number from the badge
          CURRENT=$(echo $LINE | grep -oP '(?<=version-)[0-9]+\.[0-9]+\.[0-9]+')
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT

      # Increment patch number
      - name: Bump patch
        id: bump
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "${{ steps.read_version.outputs.current_version }}"
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      # Update badge in README
      - name: Update README badge
        run: |
          sed -i "s/version-[0-9]\+\.[0-9]\+\.[0-9]\+/version-${{ steps.bump.outputs.new_version }}/" README.md

      # Commit updated README
      - name: Commit updated README
        uses: EndBug/add-and-commit@v9
        with:
          author_name: github-actions
          author_email: github-actions@github.com
          message: "Bump version to ${{ steps.bump.outputs.new_version }}"
          add: "README.md"
          github_token: ${{ secrets.GITHUB_TOKEN }}
