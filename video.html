<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mini Teams/Zoom — WebRTC + Firebase (Single File)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#0ea5ff;--muted:#94a3b8;color-scheme: dark}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#071029 0%, #071827 100%);padding:18px;box-sizing:border-box;color:#e6eef6}
    .app{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    video{width:100%;height:240px;background:#000;border-radius:8px;object-fit:cover}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#04243a;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .small{font-size:13px;color:var(--muted)}
    #chatbox{height:320px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .msg{padding:8px 10px;border-radius:10px;max-width:80%;background:rgba(255,255,255,0.02)}
    .msg.me{margin-left:auto;background:rgba(14,165,255,0.08)}
    label{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <h1 style="margin:0 0 12px 0">Mini Teams/Zoom — WebRTC + Firebase</h1>
  <div class="app">
    <div>
      <div class="card">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <label class="small">Your name</label>
            <input id="username" placeholder="Alice" value="User">
          </div>
          <div style="width:180px">
            <label class="small">Room ID</label>
            <input id="roomIdInput" placeholder="(create or paste id)">
          </div>
        </div>
        <div class="controls">
          <button id="createBtn">Create room</button>
          <button id="joinBtn" class="ghost">Join room</button>
          <button id="leaveBtn" class="ghost">Leave</button>
          <button id="toggleAudio" class="ghost">Mute</button>
          <button id="toggleVideo" class="ghost">Stop Video</button>
        </div>
        <hr style="opacity:.06;margin:12px 0">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label class="small">Local</label>
            <video id="localVideo" autoplay muted playsinline></video>
          </div>
          <div>
            <label class="small">Remote</label>
            <video id="remoteVideo" autoplay playsinline></video>
          </div>
        </div>
        <p class="small" style="margin-top:8px">Tips: open this page in two browser windows (or share the room ID) to test. Use HTTPS (GitHub Pages works).</p>
      </div>

      <div class="card" style="margin-top:12px">
        <label class="small">Console / State</label>
        <pre id="log" style="height:120px;overflow:auto;background:transparent;border-radius:8px;padding:8px;border:1px dashed rgba(255,255,255,0.03)"></pre>
      </div>
    </div>

    <div>
      <div class="card">
        <label class="small">Chat</label>
        <div id="chatbox"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="msgInput" placeholder="Type a message">
          <button id="sendMsg">Send</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <label class="small">Firebase config</label>
        <textarea id="firebaseConfig" rows=6 placeholder="Paste your Firebase config object here (replace the dummy below)">{
  /* Replace with your Firebase Web config (apiKey, authDomain, databaseURL, projectId...) */
}</textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="saveConfig">Save config</button>
          <button id="authAnon" class="ghost">Sign in (Anonymous)</button>
        </div>
        <p class="small" style="margin-top:8px">You must enable Authentication (Anonymous) and Realtime Database in your Firebase console. See steps below.</p>
      </div>
    </div>
  </div>

  <script type="module">
    // --- Firebase v9 modular imports (CDN)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, push, set, onChildAdded, update, onValue, remove } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

    // Elements
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const createBtn = document.getElementById('createBtn');
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const toggleAudio = document.getElementById('toggleAudio');
    const toggleVideo = document.getElementById('toggleVideo');
    const logEl = document.getElementById('log');
    const roomIdInput = document.getElementById('roomIdInput');
    const firebaseConfigInput = document.getElementById('firebaseConfig');
    const saveConfigBtn = document.getElementById('saveConfig');
    const authAnonBtn = document.getElementById('authAnon');
    const usernameEl = document.getElementById('username');
    const chatbox = document.getElementById('chatbox');
    const msgInput = document.getElementById('msgInput');
    const sendMsg = document.getElementById('sendMsg');

    // State
    let localStream = null;
    let pc = null;
    let roomId = null;
    let firebaseApp = null;
    let db = null;
    let auth = null;
    let roomRef = null;
    let candidatesRef = null;

    function log(...args){
      console.log(...args);
      logEl.textContent += args.join(' ') + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Default dummy config for UX — user should paste their real config
    firebaseConfigInput.value = `{

    apiKey: "AIzaSyASfT6T3_ByT7YxhgQfkf26AzNNDgeaVSo",
    authDomain: "meeting-71831.firebaseapp.com",
    projectId: "meeting-71831",
    storageBucket: "meeting-71831.firebasestorage.app",
    messagingSenderId: "48359638047",
    appId: "1:48359638047:web:e72e4cc35b59a8f85c812a",
    measurementId: "G-NNHCRQM3M2"
  };

    saveConfigBtn.onclick = () => {
      try{
        const cfg = eval('(' + firebaseConfigInput.value + ')');
        if(firebaseApp){
          log('Firebase already initialized — refreshing page recommended.');
        }
        firebaseApp = initializeApp(cfg);
        db = getDatabase(firebaseApp);
        auth = getAuth(firebaseApp);
        log('Firebase initialized');
      }catch(e){
        log('Invalid config (paste your Firebase web config object).', e);
      }
    };

    authAnonBtn.onclick = async () => {
      if(!auth) return log('Init Firebase first');
      try{ await signInAnonymously(auth); log('Signed in anonymously'); }
      catch(e){ log('Auth error', e); }
    };

    // Start local media
    async function startLocal(){
      if(localStream) return;
      try{
        localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        localVideo.srcObject = localStream;
        log('Local stream started');
      }catch(e){log('getUserMedia failed', e)}
    }

    // Create PeerConnection helper
    function makePeerConnection(){
      const pc = new RTCPeerConnection();
      // add local tracks
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      // remote track
      pc.ontrack = event => { remoteVideo.srcObject = event.streams[0]; log('Remote track received'); };
      pc.onicecandidate = e => {
        if(!e.candidate || !candidatesRef) return;
        const c = e.candidate.toJSON();
        push(candidatesRef, c);
      };
      return pc;
    }

    // Create room (offer) flow
    createBtn.onclick = async () => {
      if(!db) return log('Initialize Firebase first');
      await startLocal();
      pc = makePeerConnection();

      // room id is a push key
      roomRef = ref(db, 'rooms/' + Math.random().toString(36).substr(2,9));
      roomId = roomRef.key || roomRef._path && roomRef._path.pieces_.slice(-1)[0];
      roomIdInput.value = roomId;
      log('Creating room', roomId);

      candidatesRef = ref(db, `rooms/${roomId}/candidates/offer`);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      // save offer to DB
      await set(ref(db, `rooms/${roomId}/offer`), {
        sdp: offer.sdp,
        type: offer.type,
        createdAt: Date.now(),
        host: usernameEl.value || 'host'
      });

      // listen for answer
      onValue(ref(db, `rooms/${roomId}/answer`), async snap => {
        const data = snap.val();
        if(!data) return;
        const answer = {type: data.type, sdp: data.sdp};
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
        log('Remote answer set');
      });

      // listen for remote ICE candidates
      onChildAdded(ref(db, `rooms/${roomId}/candidates/answer`), snapshot => {
        const cand = snapshot.val();
        pc.addIceCandidate(new RTCIceCandidate(cand)).catch(e=>log('addIce failed', e));
      });

      log('Offer created and stored');
    };

    // Join room (answer) flow
    joinBtn.onclick = async () => {
      if(!db) return log('Init Firebase first');
      const id = roomIdInput.value.trim();
      if(!id) return log('Enter room id');
      roomId = id;
      await startLocal();
      pc = makePeerConnection();

      // read offer
      const offerSnap = await (await fetch('https://firebaseremoteplaceholder')).catch(()=>null); // harmless placeholder to keep code editor happy

      const offerRef = ref(db, `rooms/${roomId}/offer`);
      let offerData = null;
      onValue(offerRef, snap => { offerData = snap.val(); });
      // small wait for value (in real app better wiring)
      await new Promise(r=>setTimeout(r,700));
      if(!offerData) return log('No offer found for this room');

      await pc.setRemoteDescription({type: offerData.type, sdp: offerData.sdp});
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      // write answer
      await set(ref(db, `rooms/${roomId}/answer`), { type: answer.type, sdp: answer.sdp, createdAt: Date.now(), guest: usernameEl.value || 'guest' });

      // candidates
      candidatesRef = ref(db, `rooms/${roomId}/candidates/answer`);

      // listen for host ICE
      onChildAdded(ref(db, `rooms/${roomId}/candidates/offer`), snapshot => {
        const cand = snapshot.val();
        pc.addIceCandidate(new RTCIceCandidate(cand)).catch(e=>log('addIce failed', e));
      });

      // push our candidates
      pc.onicecandidate = e => {
        if(!e.candidate || !candidatesRef) return;
        const c = e.candidate.toJSON();
        push(candidatesRef, c);
      };

      log('Joined room and sent answer');
    };

    // Leave
    leaveBtn.onclick = async () => {
      if(pc) pc.close(); pc = null;
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
      if(roomId && db){
        try{ await remove(ref(db, `rooms/${roomId}/candidates`)); await remove(ref(db, `rooms/${roomId}/offer`)); await remove(ref(db, `rooms/${roomId}/answer`)); }catch(e){}
      }
      roomId = null; roomIdInput.value = '';
      log('Left room');
    };

    toggleAudio.onclick = () => {
      if(!localStream) return;
      const audioTrack = localStream.getAudioTracks()[0];
      if(!audioTrack) return;
      audioTrack.enabled = !audioTrack.enabled;
      toggleAudio.textContent = audioTrack.enabled ? 'Mute' : 'Unmute';
    };
    toggleVideo.onclick = () => {
      if(!localStream) return;
      const v = localStream.getVideoTracks()[0];
      if(!v) return;
      v.enabled = !v.enabled;
      toggleVideo.textContent = v.enabled ? 'Stop Video' : 'Start Video';
    };

    // Chat (simple object using realtime DB)
    sendMsg.onclick = async () => {
      if(!db || !roomId) return log('Join a room first to chat');
      const t = msgInput.value.trim(); if(!t) return;
      const payload = {text:t, from:usernameEl.value||'me', ts:Date.now()};
      await push(ref(db, `rooms/${roomId}/chat`), payload);
      msgInput.value='';
    };

    // Listen for chat messages
    function bindChat(){
      if(!db) return;
      onChildAdded(ref(db, `rooms/${roomId}/chat`), snap => {
        const m = snap.val();
        const el = document.createElement('div'); el.className='msg' + ((m.from===usernameEl.value)?' me':'');
        el.textContent = `${m.from}: ${m.text}`;
        chatbox.appendChild(el); chatbox.scrollTop = chatbox.scrollHeight;
      });
    }

    // When a roomId is set, bind chat listener automatically
    roomIdInput.addEventListener('change', ()=>{ if(roomIdInput.value) roomId=roomIdInput.value; if(roomId) bindChat(); });

    // small UX: try to start local media on load
    (async ()=>{ try{ await startLocal(); }catch(e){} })();

  </script>
</body>
</html>
