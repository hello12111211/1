<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mini Teams/Zoom Clone</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
    header { background: #464eb8; color: white; padding: 1rem; text-align: center; }
    .controls { padding: 10px; text-align: center; }
    .controls input, .controls button { margin: 5px; padding: 8px; border-radius: 6px; }
    #videos { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; justify-content: center; }
    .videoTile { position: relative; background: white; border-radius: 10px; padding: 5px; text-align: center; }
    video { width: 250px; height: 180px; background: black; border-radius: 10px; }
    .label { background: rgba(0,0,0,0.6); color: white;
             padding: 2px 6px; border-radius: 4px; font-size: 14px; margin-top: 5px; display: inline-block; }
    .hostBadge { color: gold; font-weight: bold; font-size: 12px; display: block; margin-top: 2px; }
    .hostControls { margin-top: 5px; }
    .hostControls button { margin: 2px; padding: 4px 8px; font-size: 12px; }
    .chat { background: white; border-top: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
    #chatInput { width: 70%; padding: 8px; }
  </style>
</head>
<body>
  <header><h1>Mini Teams/Zoom Clone</h1></header>

  <div class="controls">
    <input id="username" placeholder="Your name (optional)">
    <input id="roomId" placeholder="Room ID">
    <button id="createBtn">Create Room</button>
    <button id="joinBtn">Join Room</button>
    <button id="leaveBtn">Leave</button>
    <button id="toggleAudio">Mute</button>
    <button id="toggleVideo">Stop Video</button>
    <button id="switchCamera">Switch Camera</button>
    <button id="changeNameBtn">Change Name</button>
  </div>

  <div id="videos"></div>

  <div class="chat">
    <div id="chatMessages"></div>
    <input id="chatInput" placeholder="Type message...">
    <button id="sendBtn">Send</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // === Firebase config ===
    const firebaseConfig = {
      apiKey: "AIzaSyASfT6T3_ByT7YxhgQfkf26AzNNDgeaVSo",
      authDomain: "meeting-71831.firebaseapp.com",
      databaseURL: "https://meeting-71831-default-rtdb.firebaseio.com",
      projectId: "meeting-71831",
      storageBucket: "meeting-71831.appspot.com",
      messagingSenderId: "48359638047",
      appId: "1:48359638047:web:e72e4cc35b59a8f85c812a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    firebase.auth().signInAnonymously();

    // === Globals ===
    let localStream, currentFacingMode = "user";
    let username;
    let roomId;
    let peers = {};
    let myUserRef;
    let myId;
    let isHost = false;
    let originalHostId = null; // track creator

    // === Video Tile ===
    function createVideoTile(id, labelText, stream, isSelf, peerId, isHostUser) {
      const tile = document.createElement("div");
      tile.className = "videoTile";
      const video = document.createElement("video");
      video.autoplay = true; video.playsInline = true;
      if (isSelf) video.muted = true;
      if (stream) video.srcObject = stream;
      const label = document.createElement("div");
      label.className = "label"; label.textContent = labelText;

      const hostBadge = document.createElement("span");
      hostBadge.className = "hostBadge";
      hostBadge.textContent = isHostUser ? "🏆 Host" : "";
      label.appendChild(hostBadge);

      tile.appendChild(video); tile.appendChild(label);
      tile.id = "tile-" + id;

      addHostControls(tile, isSelf, peerId);

      document.getElementById("videos").appendChild(tile);
      return { video, tile, label, hostBadge };
    }

    function addHostControls(tile, isSelf, peerId) {
      const controls = tile.querySelector(".hostControls");
      if (controls) controls.remove();
      if (!isHost || isSelf) return;

      // don’t let new host kick original host
      if (peerId === originalHostId) return;

      const hostControls = document.createElement("div");
      hostControls.className = "hostControls";

      const kickBtn = document.createElement("button");
      kickBtn.textContent = "Kick";
      kickBtn.onclick = () => {
        db.ref("rooms/"+roomId+"/users/"+peerId).remove();
      };
      hostControls.appendChild(kickBtn);

      const muteBtn = document.createElement("button");
      muteBtn.textContent = "Mute";
      muteBtn.onclick = () => {
        db.ref("rooms/"+roomId+"/users/"+peerId).update({ forceMute: true });
      };
      hostControls.appendChild(muteBtn);

      const stopVidBtn = document.createElement("button");
      stopVidBtn.textContent = "Stop Video";
      stopVidBtn.onclick = () => {
        db.ref("rooms/"+roomId+"/users/"+peerId).update({ forceVideoOff: true });
      };
      hostControls.appendChild(stopVidBtn);

      const makeHostBtn = document.createElement("button");
      makeHostBtn.textContent = "Make Host";
      makeHostBtn.onclick = () => {
        db.ref("rooms/"+roomId+"/users").once("value").then(snap => {
          snap.forEach(child => child.ref.update({ host: false }));
          db.ref("rooms/"+roomId+"/users/"+peerId).update({ host: true });
        });
      };
      hostControls.appendChild(makeHostBtn);

      tile.appendChild(hostControls);
    }

    function removeVideoTile(id) {
      const el = document.getElementById("tile-" + id);
      if (el) el.remove();
    }

    // === Local Stream ===
    async function startLocalStream() {
      if (localStream) return;
      localStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: currentFacingMode }, audio: true
      });
      createVideoTile("local", username, localStream, true, myId, isHost);
    }

    // === Room ===
    async function createRoom() {
      roomId = Math.random().toString(36).substr(2,6).toUpperCase();
      document.getElementById("roomId").value = roomId;
      await joinRoom(true);
    }

    async function joinRoom(created = false) {
      if (!roomId) roomId = document.getElementById("roomId").value.trim();
      if (!roomId) return alert("Enter room ID");

      let nameInput = document.getElementById("username").value.trim();
      if (nameInput) {
        username = nameInput;
      } else {
        const snap = await db.ref("rooms/"+roomId+"/users").get();
        const count = snap.exists() ? Object.keys(snap.val()).length+1 : 1;
        username = "User" + count;
      }

      const snap = await db.ref("rooms/"+roomId+"/users").get();
      isHost = created || !snap.exists();

      myUserRef = db.ref("rooms/"+roomId+"/users").push();
      myId = myUserRef.key;
      if (isHost && !originalHostId) originalHostId = myId;

      await myUserRef.set({ name: username, host: isHost, original: isHost });

      await startLocalStream();

      db.ref("rooms/"+roomId+"/users").on("child_added", snap => {
        const peerId = snap.key, data = snap.val();
        if (peerId === myId) return;
        if (!peers[peerId]) startPeerConnection(peerId, data.name, myId, data.host);
      });

      window.addEventListener("beforeunload", () => {
        if (myUserRef) myUserRef.remove();
      });

      db.ref("rooms/"+roomId+"/users").on("child_changed", snap => {
        if (snap.key === myId) {
          isHost = snap.val().host;
        }
        updateAllHostControls();
        updateHostBadges();
      });

      myUserRef.on("value", snap => {
        const data = snap.val();
        if (!data) { 
          alert("You were removed from the room");
          location.reload();
        }
        if (data.forceMute && localStream) {
          localStream.getAudioTracks()[0].enabled = false;
        }
        if (data.forceVideoOff && localStream) {
          localStream.getVideoTracks()[0].enabled = false;
        }
      });

      if (myId === originalHostId) {
        // add reclaim button always for original host
        const btn = document.createElement("button");
        btn.textContent = "Reclaim Host";
        btn.onclick = () => {
          db.ref("rooms/"+roomId+"/users").once("value").then(snap => {
            snap.forEach(child => child.ref.update({ host: false }));
            myUserRef.update({ host: true });
          });
        };
        document.querySelector(".controls").appendChild(btn);
      }
    }

    function updateAllHostControls() {
      for (const peerId in peers) {
        const tile = peers[peerId].videoEl.closest(".videoTile");
        addHostControls(tile, false, peerId);
      }
    }

    function updateHostBadges() {
      db.ref("rooms/"+roomId+"/users").once("value").then(snap => {
        snap.forEach(child => {
          const tile = document.getElementById("tile-" + child.key);
          if (tile) {
            const badge = tile.querySelector(".hostBadge");
            badge.textContent = child.val().host ? "🏆 Host" : "";
          }
        });
        if (document.getElementById("tile-local")) {
          const badge = document.querySelector("#tile-local .hostBadge");
          if (badge) badge.textContent = isHost ? "🏆 Host" : "";
        }
      });
    }

    async function startPeerConnection(peerId, peerName, myId, isHostUser) {
      const pc = new RTCPeerConnection();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      const { video, label } = createVideoTile(peerId, peerName, null, false, peerId, isHostUser);

      pc.ontrack = e => { video.srcObject = e.streams[0]; };

      pc.onicecandidate = e => {
        if (e.candidate) {
          db.ref(`rooms/${roomId}/signals/${peerId}/${myId}/candidates`).push(e.candidate.toJSON());
        }
      };

      peers[peerId] = { pc, videoEl: video, label };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      db.ref(`rooms/${roomId}/signals/${peerId}/${myId}/offer`).set(offer);

      db.ref(`rooms/${roomId}/signals/${myId}/${peerId}/answer`).on("value", async snap => {
        if (snap.exists() && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
        }
      });

      db.ref(`rooms/${roomId}/signals/${myId}/${peerId}/candidates`).on("child_added", snap => {
        pc.addIceCandidate(new RTCIceCandidate(snap.val()));
      });
    }

    // === Controls ===
    document.getElementById("createBtn").onclick = createRoom;
    document.getElementById("joinBtn").onclick = () => joinRoom(false);
    document.getElementById("leaveBtn").onclick = () => location.reload();

    document.getElementById("toggleAudio").onclick = () => {
      if (!localStream) return;
      const track = localStream.getAudioTracks()[0];
      track.enabled = !track.enabled;
    };
    document.getElementById("toggleVideo").onclick = () => {
      if (!localStream) return;
      const track = localStream.getVideoTracks()[0];
      track.enabled = !track.enabled;
    };

    document.getElementById("switchCamera").onclick = async () => {
      if (!localStream) return;
      currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
      const newStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: currentFacingMode }, audio: true
      });
      const newTrack = newStream.getVideoTracks()[0];
      const oldTrack = localStream.getVideoTracks()[0];
      localStream.removeTrack(oldTrack);
      oldTrack.stop();
      localStream.addTrack(newTrack);
      const localTile = document.querySelector("#tile-local video");
      localTile.srcObject = localStream;
      for (const peerId in peers) {
        const sender = peers[peerId].pc.getSenders().find(s => s.track.kind === "video");
        if (sender) sender.replaceTrack(newTrack);
      }
    };

    document.getElementById("changeNameBtn").onclick = async () => {
      const newName = prompt("Enter new name:");
      if (!newName || !roomId || !myUserRef) return;
      username = newName;
      await myUserRef.update({ name: newName });
      const localLabel = document.querySelector("#tile-local .label");
      if (localLabel) localLabel.childNodes[0].textContent = newName;
    };

    // === Chat ===
    const chatMessages = document.getElementById("chatMessages");
    document.getElementById("sendBtn").onclick = () => {
      const msg = document.getElementById("chatInput").value.trim();
      if (!msg || !roomId) return;
      db.ref("chats/"+roomId).push({ user: username, text: msg });
      document.getElementById("chatInput").value = "";
    };

    db.ref("chats").on("child_added", snap => {
      if (snap.key !== roomId) return;
      snap.ref.on("child_added", msgSnap => {
        const msg = msgSnap.val();
        const div = document.createElement("div");
        div.textContent = msg.user + ": " + msg.text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    });
  </script>
</body>
</html>
