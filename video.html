<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T.D</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
    header { background: #464eb8; color: white; padding: 1rem; text-align: center; }
    #videos { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; }
    video { width: 300px; height: 200px; background: black; border-radius: 10px; }
    .controls { padding: 10px; text-align: center; }
    .controls button { margin: 5px; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; }
    .chat { background: white; border-top: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
    #chatInput { width: 80%; padding: 8px; }
    #sendBtn { padding: 8px; }
    .log { background: #eee; padding: 5px; font-size: 12px; height: 100px; overflow-y: auto; }
  </style>
</head>
<body>
  <header><h1>Video call</h1></header>

  <div class="controls">
    <input id="username" placeholder="Your name">
    <input id="roomId" placeholder="Room ID">
    <button id="createBtn">Create room</button>
    <button id="joinBtn">Join room</button>
    <button id="leaveBtn">Leave</button>
    <button id="toggleAudio">Mute</button>
    <button id="toggleVideo">Stop Video</button>
    <button id="switchCamera">Switch Camera</button>
    <button id="shareScreen">Share Screen</button>  <!-- TOMMM U WANT ME TO FIX THIS FOR UUUU ps i can prob fix Share Screen if it dosnt work-->

  </div>

  <div id="videos">
    <video id="localVideo" autoplay playsinline muted></video>
  </div>

  <div class="chat">
    <div id="chatMessages"></div>
    <input id="chatInput" placeholder="Type message...">
    <button id="sendBtn">Send</button>
  </div>

  <div class="log" id="log"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // === Firebase config ===
    const firebaseConfig = {
      apiKey: "AIzaSyASfT6T3_ByT7YxhgQfkf26AzNNDgeaVSo",
      authDomain: "meeting-71831.firebaseapp.com",
      databaseURL: "https://meeting-71831-default-rtdb.firebaseio.com",
      projectId: "meeting-71831",
      storageBucket: "meeting-71831.appspot.com",
      messagingSenderId: "48359638047",
      appId: "1:48359638047:web:e72e4cc35b59a8f85c812a",
      measurementId: "G-NNHCRQM3M2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    firebase.auth().signInAnonymously();

    // === State ===
    const localVideo = document.getElementById("localVideo");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const logBox = document.getElementById("log");
    let localStream, roomId, myId, isHost = false;
    let peers = {};
    let currentFacingMode = "user"; 
    let currentVideoTrack;

    function log(...args) {
      logBox.innerHTML += args.join(" ") + "<br>";
      logBox.scrollTop = logBox.scrollHeight;
      console.log(...args);
    }

    async function startLocalStream() {
      if (localStream) return;
      localStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: currentFacingMode },
        audio: true
      });
      currentVideoTrack = localStream.getVideoTracks()[0];
      localVideo.srcObject = localStream;
    }

    function addRemoteVideo(id, stream) {
      let v = document.getElementById("video_" + id);
      if (!v) {
        v = document.createElement("video");
        v.id = "video_" + id;
        v.autoplay = true;
        v.playsinline = true;
        document.getElementById("videos").appendChild(v);
      }
      v.srcObject = stream;
    }

    function removeRemoteVideo(id) {
      const v = document.getElementById("video_" + id);
      if (v) v.remove();
    }

    async function startPeer(peerId, isInitiator) {
      const pc = new RTCPeerConnection();
      peers[peerId] = pc;

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      pc.ontrack = e => addRemoteVideo(peerId, e.streams[0]);

      const connRef = db.ref(`signals/${roomId}/${myId}-${peerId}`);
      const backRef = db.ref(`signals/${roomId}/${peerId}-${myId}`);

      pc.onicecandidate = e => {
        if (e.candidate) connRef.push({ candidate: e.candidate.toJSON() });
      };

      if (isInitiator) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        connRef.push({ offer: { type: offer.type, sdp: offer.sdp } });
      }

      backRef.on("child_added", async snap => {
        const data = snap.val();
        if (data.offer) {
          if (!pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            connRef.push({ answer: { type: answer.type, sdp: answer.sdp } });
          }
        } else if (data.answer) {
          if (!pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
          }
        } else if (data.candidate) {
          try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); }
          catch (err) { console.error("Error adding ICE", err); }
        }
      });
    }

    async function createRoom() {
      await startLocalStream();
      roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
      document.getElementById("roomId").value = roomId;
      myId = Date.now().toString(36);
      isHost = true;

      const roomRef = db.ref("rooms/" + roomId);
      roomRef.push({ id: myId });

      roomRef.on("child_added", snap => {
        const peerId = snap.val().id;
        if (peerId === myId) return;
        const isInitiator = myId > peerId;
        if (!peers[peerId]) startPeer(peerId, isInitiator);
      });

      setupChat();
      log("Created room", roomId);
    }

    async function joinRoom() {
      await startLocalStream();
      roomId = document.getElementById("roomId").value;
      myId = Date.now().toString(36);
      isHost = false;

      const roomRef = db.ref("rooms/" + roomId);
      const snap = await roomRef.get();
      if (!snap.exists()) return alert("Room not found");

      roomRef.push({ id: myId });

      roomRef.on("child_added", snap => {
        const peerId = snap.val().id;
        if (peerId === myId) return;
        const isInitiator = myId > peerId;
        if (!peers[peerId]) startPeer(peerId, isInitiator);
      });

      setupChat();
      log("Joined room", roomId);
    }

    function setupChat() {
      db.ref("chats/" + roomId).on("child_added", msgSnap => {
        const msg = msgSnap.val();
        const div = document.createElement("div");
        div.textContent = msg.user + ": " + msg.text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }

    document.getElementById("sendBtn").onclick = () => {
      const msg = chatInput.value;
      if (!msg || !roomId) return;
      const user = document.getElementById("username").value || "User";
      db.ref("chats/" + roomId).push({ user, text: msg });
      chatInput.value = "";
    };

    document.getElementById("shareScreen").onclick = async () => {
      if (!roomId) return alert("Join or create a room first");

      if (isHost) {
        startScreenShare();
      } else {
        db.ref(`requests/${roomId}`).push({ from: myId });
        alert("Request sent to host");
      }
    };

    db.ref("requests").on("child_added", snap => {
      const rId = snap.key;
      if (rId !== roomId || !isHost) return;
      snap.ref.on("child_added", reqSnap => {
        const req = reqSnap.val();
        if (confirm("Allow " + req.from + " to share screen?")) {
          db.ref(`approvals/${roomId}/${req.from}`).set(true);
        }
      });
    });

    db.ref("approvals").on("child_added", snap => {
      const rId = snap.key;
      if (rId !== roomId) return;
      snap.ref.on("child_added", async appSnap => {
        if (appSnap.key === myId) {
          startScreenShare();
        }
      });
    });

    async function startScreenShare() {
      try {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const screenTrack = screenStream.getVideoTracks()[0];

        // Replace track for peers
        Object.values(peers).forEach(pc => {
          const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
          if (sender) sender.replaceTrack(screenTrack);
        });

        // Local preview
        localStream.removeTrack(currentVideoTrack);
        currentVideoTrack.stop();
        localStream.addTrack(screenTrack);
        localVideo.srcObject = localStream;
        currentVideoTrack = screenTrack;

        log("Screen sharing started");

        // When stopped â†’ restore camera
        screenTrack.onended = async () => {
          const camStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: currentFacingMode },
            audio: true
          });
          const camTrack = camStream.getVideoTracks()[0];

          Object.values(peers).forEach(pc => {
            const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
            if (sender) sender.replaceTrack(camTrack);
          });

          localStream.removeTrack(currentVideoTrack);
          currentVideoTrack.stop();
          localStream.addTrack(camTrack);
          localVideo.srcObject = localStream;
          currentVideoTrack = camTrack;

          log("Returned to camera");
        };
      } catch (err) {
        console.error("Screen share failed", err);
      }
    }

    document.getElementById("createBtn").onclick = createRoom;
    document.getElementById("joinBtn").onclick = joinRoom;
    document.getElementById("leaveBtn").onclick = () => location.reload();

    document.getElementById("toggleAudio").onclick = () => {
      if (!localStream) return;
      const track = localStream.getAudioTracks()[0];
      track.enabled = !track.enabled;
    };
    document.getElementById("toggleVideo").onclick = () => {
      if (!localStream) return;
      const track = localStream.getVideoTracks()[0];
      track.enabled = !track.enabled;
    };

    document.getElementById("switchCamera").onclick = async () => {
      if (!localStream) return;
      currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
      const newStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: currentFacingMode },
        audio: true
      });
      const newTrack = newStream.getVideoTracks()[0];

      localStream.removeTrack(currentVideoTrack);
      currentVideoTrack.stop();
      localStream.addTrack(newTrack);
      currentVideoTrack = newTrack;
      localVideo.srcObject = localStream;

      Object.values(peers).forEach(pc => {
        const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
        if (sender) sender.replaceTrack(newTrack);
      });

      log("Switched camera");
    };
  </script>
  <p>Don't use in school</p>
  <p>If you use in school and get caught that is your fault not mine. You have been warned.</p>
</body>
</html>
